-- Drop existing tables
DROP TABLE IF EXISTS UserMovies, UserFriends, PendingRequests, AcceptedFriends, Movies, Users;

-- Recreate Users Table
CREATE TABLE Users (
    UserID INT AUTO_INCREMENT PRIMARY KEY,
    Username VARCHAR(50) UNIQUE NOT NULL,
    Password VARCHAR(255) NOT NULL,
    Salt VARCHAR(255) NOT NULL
);

-- Recreate Movies Table
CREATE TABLE Movies (
    MovieID INT AUTO_INCREMENT PRIMARY KEY,
    Title VARCHAR(100) NOT NULL,
    Director VARCHAR(100),
    ReleaseDate DATE
);

-- Recreate UserMovies Table
CREATE TABLE UserMovies (
    UserMovieID INT AUTO_INCREMENT PRIMARY KEY,
    UserID INT,
    MovieID INT,
    UserRating DECIMAL(3, 1) CHECK (UserRating BETWEEN 0.0 AND 10.0),
    Title VARCHAR(100) NOT NULL,
    FOREIGN KEY (UserID) REFERENCES Users(UserID),
    FOREIGN KEY (MovieID) REFERENCES Movies(MovieID)
);


-- Recreate PendingRequests Table
CREATE TABLE PendingRequests (
    RequestID INT AUTO_INCREMENT PRIMARY KEY,
    SenderID INT,
    ReceiverID INT,
    RequestDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (SenderID) REFERENCES Users(UserID),
    FOREIGN KEY (ReceiverID) REFERENCES Users(UserID)
);

-- Recreate AcceptedFriends Table
CREATE TABLE AcceptedFriends (
    FriendshipID INT AUTO_INCREMENT PRIMARY KEY,
    UserID1 INT,
    UserID2 INT,
    FriendshipDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (UserID1) REFERENCES Users(UserID),
    FOREIGN KEY (UserID2) REFERENCES Users(UserID)
);

-- Alter UserMovies Table
ALTER TABLE UserMovies
ADD COLUMN Title VARCHAR(100) NOT NULL AFTER MovieID;

ALTER TABLE UserMovies
ADD COLUMN FriendshipID INT,
ADD FOREIGN KEY (FriendshipID) REFERENCES UserFriends(FriendshipID);
ALTER TABLE UserMovies ADD CONSTRAINT unique_movie_per_user UNIQUE (UserID, Title);
